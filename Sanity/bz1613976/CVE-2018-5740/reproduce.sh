#!/bin/sh
#
# Requires perl module Net::DNS::Nameserver and bind-utils

#NAMED=$(realpath ../../../named/named)
NAMED=named

setup()
{
	ip a add 10.53.0.1/24 dev lo
	ip a add 10.53.0.3/24 dev lo
	ip a add 10.53.0.4/24 dev lo
}

start()
{
	(cd ns1 && $NAMED -c named.conf -g &>named.run &)
	(cd ns4 && $NAMED -c named.conf -g &>named.run &)
	(cd ans3 && perl ans.pl &>ans.run &)

	sleep 1
}

cleanup()
{
	kill $(cat ns1/named.pid) $(cat ns4/named.pid) $(cat ans3/ans.pid)
}

start

if ! ps u "$(cat ns4/named.pid)"; then
	echo "Failed to start server, test failure."
	exit 1
fi

dig @10.53.0.4 -p 5300 -t dname synth2-then-dname.example.broken

if ! ps u "$(cat ns4/named.pid)"; then
	echo "SUCCESS! process is missing"
	tail ns4/named.run
fi

cleanup
